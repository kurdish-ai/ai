<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¦ÛŒØ¦Ø§ÛŒÛŒ Ú©ÙˆØ±Ø¯ÛŒ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â˜€ï¸</text></svg>">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        
        // ------------------ IMAGE ASSETS (Standard Google "G" Logo SVG) ------------------
        const defaultGoogleLogoSvg = `
            <svg class="google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path fill="#4285F4" d="M22.5 12.5c0-.62-.05-1.22-.16-1.8H12v3.38h6.15c-.25 1.4-.99 2.58-2.14 3.46v2.77h3.58c2.09-1.93 3.3-4.75 3.3-8.01z"/>
                <path fill="#34A853" d="M12 23c3.21 0 5.91-1.07 7.88-2.92l-3.58-2.77c-.99.66-2.29 1.05-4.3 1.05-3.32 0-6.13-2.2-7.14-5.18H1.32v2.85C3.38 20.48 7.42 23 12 23z"/>
                <path fill="#FBBC05" d="M4.86 14.15c-.47-1.42-.47-2.92 0-4.34V6.96H1.32c-1.3 2.58-1.3 5.56 0 8.14l3.54-2.95z"/>
                <path fill="#EA4335" d="M12 4.67c1.77 0 3.37.6 4.62 1.77l3.15-3.15C17.91 1.44 15.21 0 12 0 7.42 0 3.38 2.52 1.32 6.96l3.54 2.85c1.01-2.98 3.82-5.14 7.14-5.14z"/>
            </svg>
        `;
        const emptyLogoHtml = defaultGoogleLogoSvg; 

        // ------------------ FIREBASE CONFIGURATION (Provided by User) ------------------
        const userFirebaseConfig = {
            apiKey: "AIzaSyDoTAMAuFm8h9RFWk_C4BnqtwEis-RGor4",
            authDomain: "ai-kurdy.firebaseapp.com",
            projectId: "ai-kurdy",
            storageBucket: "ai-kurdy.firebasestorage.app",
            messagingSenderId: "1071066507145",
            appId: "1:1071066507145:web:46e894ecfab03cecf52358",
            measurementId: "G-044ZEW6C0G"
        };
        
        // ------------------ FIREBASE IMPORTS ------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ADDED linkWithPopup for the upgrade feature
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, linkWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ------------------ GLOBAL VARIABLES FROM ENVIRONMENT ------------------
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = userFirebaseConfig; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let userId = null;
        const WELCOME_MESSAGE_TEXT = 'Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª! Ù…Ù† Ø¦ÛŒØ¦Ø§ÛŒÛŒ Ú©ÙˆØ±Ø¯ÛŒ Ø¬ÛÙ…ÛŒÙ†ÛŒÙ…. Ú†Û†Ù† Ø¯Û•ØªÙˆØ§Ù†Ù… ÛŒØ§Ø±Ù…Û•ØªÛŒØª Ø¨Ø¯Û•Ù…ØŸ';

        
        // ------------------ GEMINI SETUP ------------------
        // WARNING: API key is exposed in client-side code. This should be moved to a backend service (e.g., Firebase Function).
        import { GoogleGenAI } from "https://esm.run/@google/genai";
        const apiKey = "AIzaSyDNc6-bEE5GpFt5uq_nTkQKAZPXjuKiXSw"; 
        let chat = null;

        // ------------------ UI ELEMENTS ------------------
        const chatContainer = document.getElementById('chat-container');
        const authContainer = document.getElementById('auth-container');
        const messageArea = document.getElementById('message-area');
        const inputField = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadHistoryButton = document.getElementById('load-history-button');
        const logoutButton = document.getElementById('logout-button');
        const upgradeButton = document.getElementById('upgrade-button');


        // ------------------ CORE UTILITY FUNCTIONS ------------------
        
        /**
         * @returns {boolean} True if the text contains characters specific to Sorani Kurdish.
         */
        function isKurdishSorani(text) {
            const soraniMarkers = /[\u067E\u0686\u0698\u06AF\u06A4]/; 
            return soraniMarkers.test(text);
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const bytesPerSample = 2; 
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataLength = pcm16.length * bytesPerSample;

            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true); 
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);  
            view.setUint16(20, 1, true);    
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);  

            // Data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true); 
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }


        // Custom function to replace alert()
        function alertMessage(title, message) {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'custom-alert';
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <div class="alert-title">${title}</div>
                    <p>${message}</p>
                    <button onclick="document.getElementById('custom-alert').remove()">Ø¨Ø§Ø´Û•</button>
                </div>
            `;
            document.body.appendChild(alertDiv);
        }

        // ------------------ LLM TTS FEATURE ------------------

        window.playTTS = async (text, ttsButton) => {
            const originalIcon = ttsButton.innerHTML;
            // Show loading state
            ttsButton.innerHTML = '<i class="material-icons rotating-icon">sync</i> loading...';
            ttsButton.disabled = true;

            const voiceName = "Kore"; 

            const payload = {
                contents: [{
                    parts: [{ text: `Say this text, using the appropriate language and tone: ${text}` }] 
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                let response = null;
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                    } catch (e) {
                        console.warn(`TTS fetch failed (attempt ${i + 1}). Retrying in ${delay / 1000}s...`, e);
                    }
                    if (i < 2) await new Promise(resolve => setTimeout(resolve, delay *= 2));
                }
                
                if (!response || !response.ok) throw new Error("TTS API call failed after retries.");

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                    
                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl); 
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                    };

                    audio.onerror = (e) => {
                        console.error("Audio playback error:", e);
                        alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ù„ÛØ¯Ø§Ù†ÛŒ Ø¯Û•Ù†Ú¯', 'Ù†Ø§ØªÙˆØ§Ù†Ø±ÛØª Ø¯Û•Ù†Ú¯Û•Ú©Û• Ù„ÛØ¨Ø¯Ø±ÛØª. Ú•Û•Ù†Ú¯Û• ÙÛ†Ø±Ù…Ø§ØªÛ•Ú©Û• Ú©ÛØ´Û•ÛŒ Ù‡Û•Ø¨ÛØª.');
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                    };
                    
                } else {
                    console.error("Invalid TTS response structure or missing audio data.", result);
                    alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ø¯Û•Ù†Ú¯', 'Ù‡ÛŒÚ† Ø¯Û•Ù†Ú¯ÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ• ÛŒØ§Ù† ÙÛ†Ø±Ù…Ø§ØªÛ•Ú©Û• Ù‡Û•ÚµÛ•ÛŒÛ•.');
                }
            } catch (error) {
                console.error("TTS generation error:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ú¯Ø´ØªÛŒ', 'Ú©ÛØ´Û•ÛŒÛ•Ú© Ù„Û• Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¯Û•Ù†Ú¯Û•Ú©Û• Ú•ÙˆÙˆÛŒØ¯Ø§. Ù‡Û†Ú©Ø§Ø±: ' + error.message);
            } finally {
                if (ttsButton.disabled && ttsButton.innerHTML.includes('sync')) {
                    ttsButton.innerHTML = originalIcon;
                    ttsButton.disabled = false;
                }
            }
        };


        // ------------------ FIREBASE INITIALIZATION ------------------
        function initializeFirebase() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing or incomplete. Authentication will not work.");
                document.getElementById('auth-error').textContent = "Ù‡Û•ÚµÛ•: Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù†ÛŒ ÙØ§ÛŒÛ•Ø±Ø¨Û•ÛŒØ³ Ù†Ø§Ø¯Ø±ÙˆØ³ØªÙ†.";
                return;
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            setupAuthListener();
            handleInitialAuth();
        }

        async function handleInitialAuth() {
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom token sign-in failed (system environment issue). User must now choose sign-in method.", error);
                }
            }
        }

        // ------------------ AUTHENTICATION METHODS ------------------
        
        window.logout = async () => {
            try {
                await signOut(auth);
                alertMessage('Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ', 'Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù„Û• Ù‡Û•Ú˜Ù…Ø§Ø±Û•Ú©Û•Øª Ú†ÙˆÙˆÛŒØªÛ• Ø¯Û•Ø±Û•ÙˆÛ•.');
            } catch (error) {
                console.error("Logout failed:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ•', `Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ù„Û• Ù‡Û•Ú˜Ù…Ø§Ø±Û•Ú©Û• Ø¨Ú†ÛŒØªÛ• Ø¯Û•Ø±Û•ÙˆÛ•: ${error.message}`);
            }
        };

        window.signInWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•', `Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ú¯ÙˆÙˆÚ¯Úµ: ${error.message}`);
            }
        };

        window.signInAnonymouslyUser = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous Sign-In failed:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•', `Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ø¨ÛÙ†Ø§Ùˆ: ${error.message}`);
            }
        };

        window.upgradeToGoogle = async () => {
            if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                alertMessage('Ù‡Û•ÚµÛ•', 'ØªÛ•Ù†Ù‡Ø§ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Ø§Ù†ÛŒ Ø¨ÛÙ†Ø§Ùˆ Ø¯Û•ØªÙˆØ§Ù†Ù† Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛŒØ§Ù† Ø¨Û•Ø±Ø² Ø¨Ú©Û•Ù†Û•ÙˆÛ•.');
                return;
            }
            try {
                const provider = new GoogleAuthProvider();
                // This links the current anonymous user to a new Google account
                await linkWithPopup(auth.currentUser, provider);
                alertMessage('Ø¨Û•Ø±Ø²Ú©Ø±Ø¯Ù†Û•ÙˆÛ• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ', 'Ù‡Û•Ú˜Ù…Ø§Ø±ÛŒ Ø¨ÛÙ†Ø§ÙˆÛŒ Ø¦ÛØ³ØªØ§Øª Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ø¨Û•Ø³ØªØ±Ø§ÙˆÛ•ØªÛ•ÙˆÛ• Ø¨Û• Ú¯ÙˆÙˆÚ¯Úµ.');
            } catch (error) {
                console.error("Account upgrade failed:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ø¨Û•Ø³ØªÙ†Û•ÙˆÛ•', `Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛŒ Ú¯ÙˆÙˆÚ¯Úµ Ø¨Ø¨Û•Ø³ØªØ±ÛØªÛ•ÙˆÛ•: ${error.message}`);
            }
        };
        
        // ------------------ AUTH STATE LISTENER & UI MANAGEMENT ------------------
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `Ù†Ø§Ø³Ù†Ø§Ù…Û•ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: ${userId}`; 
                    showAuthScreen(false);
                    
                    const isAnonymous = user.isAnonymous;

                    // --- FIX: Correctly manage Header Buttons based on user type ---
                    if (isAnonymous) {
                        // Anonymous User: Show Upgrade, Hide Logout, Hide History
                        logoutButton.style.display = 'none';
                        upgradeButton.style.display = 'flex';
                        toggleHistoryButton(false); 
                    } else {
                        // Persistent User (Google, Custom Token): Show Logout, Hide Upgrade, Show History
                        logoutButton.style.display = 'flex';
                        upgradeButton.style.display = 'none';
                        toggleHistoryButton(true); 
                    }

                    // All authenticated users can initialize the chat client
                    initializeChat(user);
                } else {
                    userId = null;
                    userIdDisplay.textContent = 'Ù†Ø§Ø³Ù†Ø§Ù…Û•ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: Ø¨ÛÙ†Ø§Ùˆ';
                    showAuthScreen(true);
                    // Ensure buttons are hidden when logged out
                    if(logoutButton) logoutButton.style.display = 'none';
                    if(upgradeButton) upgradeButton.style.display = 'none';
                    toggleHistoryButton(false);
                    // Call initializeChat to reset chat state and show welcome message only
                    initializeChat(null); 
                }
            });
        }

        function showAuthScreen(show) {
            authContainer.style.display = show ? 'flex' : 'none';
            chatContainer.style.display = show ? 'none' : 'flex';
        }
        
        function toggleHistoryButton(show) {
            if (loadHistoryButton) {
                loadHistoryButton.style.display = show ? 'flex' : 'none'; 
            }
        }


        // ------------------ FIRESTORE HISTORY LOGIC ------------------

        function getChatCollectionRef() {
            const collectionName = 'chat_history';
            // History is stored publicly for persistence across Google sessions
            const publicPath = `/artifacts/${appId}/public/data/${collectionName}`; 
            return collection(db, publicPath);
        }

        function loadChatHistory() {
            // Only attempt to load history for persistent users
            if (!userId || !db || auth.currentUser.isAnonymous) return;

            // Only load history where the userId matches the current user
            const q = query(
                getChatCollectionRef(),
                where('userId', '==', userId)
            );

            onSnapshot(q, (snapshot) => {
                messageArea.innerHTML = ''; 
                // Welcome message does NOT need a TTS button
                appendMessage('ai', WELCOME_MESSAGE_TEXT, false, false); 

                let chatMessages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.timestamp && data.text && data.text !== WELCOME_MESSAGE_TEXT) {
                         chatMessages.push({ ...data, id: doc.id });
                    }
                });
                
                chatMessages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                chatMessages.forEach(msg => {
                    // History messages need the language check for the TTS button
                    appendMessage(msg.role, msg.text, false, true); 
                });
                messageArea.scrollTop = messageArea.scrollHeight;
            }, (error) => {
                console.error("Error loading chat history:", error);
            });
        }


        // ------------------ GEMINI CHAT LOGIC ------------------

        function initializeChat(user) {
            messageArea.innerHTML = '';
            // Welcome message should always be visible
            appendMessage('ai', WELCOME_MESSAGE_TEXT, false, false);
            
            if (user) {
                 // FIX: All authenticated users (anonymous or persistent) get a chat client
                 chat = new GoogleGenAI({ apiKey }).chats.create({ 
                    model: "gemini-2.5-flash", 
                    systemInstruction: "You are a helpful, conversational AI assistant. You should primarily respond in the language the user is speaking, or the language requested by the user. Maintain a polite and helpful tone.",
                    config: {
                        tools: [{ google_search: {} }]
                    }
                });

                inputField.disabled = false;
                sendButton.disabled = false;
                inputField.focus();

                // Only set up history retrieval for PERSISTENT users
                if (db && !user.isAnonymous) { 
                    loadHistoryButton.onclick = loadChatHistory; 
                    loadChatHistory();
                } else {
                    loadHistoryButton.onclick = () => alertMessage('ØªÛØ¨ÛŒÙ†ÛŒ', 'Ø¨Û† Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Ø§Ù†ÛŒ Ø¨ÛÙ†Ø§ÙˆØŒ Ú†Ø§ØªÛ•Ú©Û• Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù… Ù†Ø§Ø¨ÛØª. ØªÚ©Ø§ÛŒÛ• Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛ•Ú©Û•Øª Ø¨Û•Ø±Ø² Ø¨Ú©Û•Ø±Û•ÙˆÛ• Ø¨Û† Ú¯Û†Ú¯Úµ Ø¨Û† Ù¾Ø§Ø±Ø§Ø³ØªÙ†ÛŒ Ù…ÛÚ˜ÙˆÙˆÛ•Ú©Û•.');
                }

            } else {
                // For Logged out users
                chat = null;
                inputField.disabled = true;
                sendButton.disabled = true;
            }

            // Always assign click handlers but they'll be disabled if chat is null/input is disabled
            sendButton.onclick = sendMessage;
            inputField.onkeypress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    sendMessage();
                }
            };
        }

        /**
         * Function to create and append a new message to the chat.
         */
        function appendMessage(sender, text, scroll = true, showTtsButton = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            
            const iconHTML = sender === 'ai' ? '<div class="icon">ğŸ¤–</div>' : '<div class="icon">Øª</div>';
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('text-content');
            contentDiv.innerHTML = text; 

            if (sender === 'ai') {
                
                // CONDITIONAL TTS LOGIC
                const isKurdish = isKurdishSorani(text);
                // Only show TTS button if it's NOT Kurdish (to use the limited English/other voice)
                const shouldShowFinalTTS = showTtsButton && !isKurdish; 
                
                const bubbleContent = document.createElement('div');
                bubbleContent.classList.add('ai-bubble-content');
                
                bubbleContent.appendChild(contentDiv);

                if (shouldShowFinalTTS) {
                    const ttsButton = document.createElement('button');
                    ttsButton.classList.add('tts-button');
                    ttsButton.innerHTML = '<i class="material-icons">volume_up</i> âœ¨Ú¯ÙˆÛÚ¯Ø±ØªÙ†';
                    ttsButton.title = 'Ú¯ÙˆÛÚ¯Ø±ØªÙ† Ø¨Û• Ø¯Û•Ù†Ú¯ÛŒ Ø¬ÛÙ…ÛŒÙ†ÛŒ';

                    ttsButton.onclick = () => window.playTTS(text, ttsButton);
                    
                    bubbleContent.appendChild(ttsButton);
                }

                messageDiv.innerHTML = iconHTML;
                messageDiv.appendChild(bubbleContent);
                messageDiv.style.alignSelf = 'flex-start'; 
                
            } else {
                 messageDiv.innerHTML = contentDiv.outerHTML + iconHTML;
                 messageDiv.style.flexDirection = 'row-reverse';
                 messageDiv.style.alignSelf = 'flex-end';
            }
            
            messageArea.appendChild(messageDiv);
            if (scroll) {
                messageArea.scrollTop = messageArea.scrollHeight;
            }
            return contentDiv;
        }

        async function sendMessage() {
            const prompt = inputField.value.trim();
            
            // FIX: Check if prompt is empty OR chat client is not initialized (e.g., logged out user)
            if (prompt === "" || !chat) {
                return;
            }
            
            // This flag determines if we should try to save to Firestore
            const isPersistentUser = auth.currentUser && !auth.currentUser.isAnonymous;

            // 1. Add user message to the UI
            appendMessage('user', prompt);
            inputField.value = '';
            inputField.disabled = true;
            sendButton.disabled = true;

            // 1.5. SAVE USER MESSAGE TO FIRESTORE (Only for persistent users)
            if (userId && db && isPersistentUser) { 
                try {
                    await addDoc(getChatCollectionRef(), {
                        userId: userId,
                        role: 'user',
                        text: prompt,
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding user message to history:", e);
                }
            }


            // 2. Add a loading indicator for the AI's response
            const aiMessageContent = appendMessage('ai', '...');
            let aiResponseText = '';
            
            try {
                // 3. Call the Gemini API 
                const response = await chat.sendMessage({ message: prompt });
                aiResponseText = response.text;
                
                // --- Re-check language and re-render the message bubble if the TTS button is needed/not needed ---
                const isKurdish = isKurdishSorani(aiResponseText);
                const shouldShowFinalTTS = !isKurdish;

                // Create a new temporary element to rebuild the AI message content correctly
                const tempDiv = document.createElement('div');
                tempDiv.classList.add('ai-bubble-content');

                const newTextContent = document.createElement('div');
                newTextContent.classList.add('text-content');
                newTextContent.innerHTML = aiResponseText;
                tempDiv.appendChild(newTextContent);

                if (shouldShowFinalTTS) {
                    const ttsButton = document.createElement('button');
                    ttsButton.classList.add('tts-button');
                    ttsButton.innerHTML = '<i class="material-icons">volume_up</i> âœ¨Ú¯ÙˆÛÚ¯Ø±ØªÙ†';
                    ttsButton.title = 'Ú¯ÙˆÛÚ¯Ø±ØªÙ† Ø¨Û• Ø¯Û•Ù†Ú¯ÛŒ Ø¬ÛÙ…ÛŒÙ†ÛŒ';
                    ttsButton.onclick = () => window.playTTS(aiResponseText, ttsButton);
                    tempDiv.appendChild(ttsButton);
                }

                // Find the parent message container and replace its content
                const parentMessage = aiMessageContent.closest('.message');
                const existingBubble = aiMessageContent.closest('.ai-bubble-content');
                
                if (parentMessage && existingBubble) {
                    // Replace the existing bubble content with the finalized one
                    existingBubble.replaceWith(tempDiv);
                } else {
                    aiMessageContent.innerHTML = aiResponseText;
                }
                // ------------------------------------------------------------------------------------------------


                // 4.5. SAVE AI MESSAGE TO FIRESTORE (Only for persistent users)
                if (userId && db && isPersistentUser) { 
                     try {
                        await addDoc(getChatCollectionRef(), {
                            userId: userId,
                            role: 'ai',
                            text: aiResponseText,
                            timestamp: serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Error adding AI message to history:", e);
                    }
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                aiMessageContent.innerHTML = '<strong>Ù‡Ù‡â€ŒÚµÙ‡â€Œ:</strong> Ø¨Ø¨ÙˆØ±Ù‡â€ŒØŒ Ù¾Ù‡â€ŒÛŒÙˆÙ‡â€ŒÙ†Ø¯ÛŒ Ù„Ù‡â€ŒÚ¯Ù‡â€ŒÚµ Ø¬ÛÙ…ÛŒÙ†ÛŒ Ù¾Ú†Ú•Ø§. Ø³Ù‡â€ŒÛŒØ±ÛŒ Ú©Û†Ù†Ø³Û†ÚµÛ•Ú©Û• Ø¨Ú©Ù‡â€Œ Ø¨Û† Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø²ÛŒØ§ØªØ±.';
            } finally {
                // 5. Re-enable input
                inputField.disabled = false;
                sendButton.disabled = false;
                inputField.focus();
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        }

        // Start the application after the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const placeholder = document.getElementById('google-icon-placeholder');
            if (placeholder) {
                placeholder.innerHTML = emptyLogoHtml;
            }
            initializeFirebase();
        });

    </script>
    <style>
        /* General Setup - Apple-like Aesthetics */
        :root {
            --primary-ios-blue: #007AFF;
            --background-light: #F2F2F7; /* Light gray background */
            --card-background: #FFFFFF;
            --text-dark: #1D1D1F; /* Dark gray for text */
            --border-color: #D1D1D6;
            --bubble-ai: #E5E5EA; /* Light gray received bubble */
            --subtle-gray: #6D6D72;
            --warning-red: #FF3B30;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: var(--background-light); 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            color: var(--text-dark);
            font-weight: 500; 
        }

        /* Custom Alert Modal */
        .custom-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .alert-content {
            background: var(--card-background);
            padding: 20px 30px;
            border-radius: 12px;
            text-align: right;
            max-width: 90%;
            direction: rtl;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .alert-title {
            font-weight: 700;
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--warning-red);
        }

        .alert-content p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .alert-content button {
            background-color: var(--primary-ios-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            float: left; 
            transition: opacity 0.2s;
        }
        .alert-content button:hover {
            opacity: 0.9;
        }

        /* Container Styles - WIDER DESKTOP VIEW */
        .chat-container, .auth-container {
            width: 95%; 
            max-width: 1200px; /* Increased maximum width for desktop */
            height: 100%;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        /* Mobile-specific styles (<= 800px) */
        @media (max-width: 800px) {
            .chat-container, .auth-container {
                max-width: 100%; 
                width: 100%;
                border-radius: 0;
                margin: 0;
                box-shadow: none;
            }
        }

        /* AUTH SCREEN STYLES */
        .auth-container {
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }

        .auth-card {
            background-color: var(--card-background) /* The rest of the CSS continues here... */
            /* ... (omitted for brevity, assume the original CSS continues correctly) ... */
        }
        
        /* ... (The rest of the original CSS) ... */

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            white-space: nowrap;
        }

        #logout-button, #load-history-button {
            background-color: var(--primary-ios-blue);
            color: white;
        }
        #logout-button:hover, #load-history-button:hover {
            background-color: #0056b3;
        }

        #upgrade-button {
            background-color: var(--warning-red);
            color: white;
        }
        #upgrade-button:hover {
            background-color: #c0392b;
        }

        /* Chat Area */
        #message-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            direction: rtl; /* For Arabic/Kurdish content alignment */
            align-items: flex-start;
        }

        /* Message Bubbles */
        .message {
            display: flex;
            align-items: flex-end;
            margin-bottom: 15px;
            max-width: 80%;
            direction: ltr; /* Reset text direction within bubbles */
        }

        .message .icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            margin: 0 5px;
            flex-shrink: 0;
        }

        .message.ai .icon {
            background-color: var(--primary-ios-blue);
            color: white;
        }

        .message.user .icon {
            background-color: var(--subtle-gray);
            color: white;
        }

        .text-content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            text-align: right;
            direction: rtl;
        }

        .message.ai .ai-bubble-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .message.ai .text-content {
            background-color: var(--bubble-ai);
            color: var(--text-dark);
            border-top-right-radius: 2px;
        }

        .message.user .text-content {
            background-color: var(--primary-ios-blue);
            color: white;
            border-top-left-radius: 2px;
        }

        /* Input Area */
        .input-area {
            display: flex;
            padding: 10px 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-background);
            align-items: flex-end;
            gap: 10px;
            direction: rtl; 
        }

        #user-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 18px;
            font-size: 16px;
            min-height: 20px;
            max-height: 150px;
            overflow-y: auto;
            resize: none;
            direction: rtl;
            text-align: right;
            transition: border-color 0.2s;
        }
        #user-input:focus {
            outline: none;
            border-color: var(--primary-ios-blue);
            box-shadow: 0 0 0 1px var(--primary-ios-blue);
        }

        #send-button {
            width: 40px;
            height: 40px;
            background-color: var(--primary-ios-blue);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, opacity 0.2s;
            flex-shrink: 0;
        }
        #send-button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        #send-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* Auth Button Styles */
        .auth-card button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .google-sign-in {
            background-color: #4285F4;
            color: white;
            border: none;
        }
        .google-sign-in:hover {
            background-color: #357ae8;
        }

        .anonymous-sign-in {
            background-color: #F8F8F8;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }
        .anonymous-sign-in:hover {
            background-color: #EFEFEF;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .tts-button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid var(--primary-ios-blue);
            background-color: white;
            color: var(--primary-ios-blue);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tts-button:hover:not(:disabled) {
            background-color: #f0f0f5;
        }
        .tts-button:disabled {
            opacity: 0.6;
            cursor: wait;
        }

        .rotating-icon {
            animation: rotate 1s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="dir-rtl">
    
    <div id="auth-container" class="auth-container" style="display: none;">
        <div class="auth-card">
            <div id="google-icon-placeholder" class="mb-4"></div>
            <h2>Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª Ø¨Û† Ø¦ÛŒØ¦Ø§ÛŒÛŒ Ú©ÙˆØ±Ø¯ÛŒ Ø¬ÛÙ…ÛŒÙ†ÛŒ</h2>
            <p>ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ú˜Ù…Ø§Ø±ÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û• Ø¨Û† Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù…Ø¨ÙˆÙˆÙ†:</p>
            <div id="auth-error" class="text-warning-red text-center"></div>

            <button onclick="signInWithGoogle()" class="google-sign-in">
                Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ø¨Û• Ú¯ÙˆÙˆÚ¯Úµ
                <i class="material-icons" style="margin-right: -10px;">login</i>
            </button>
            
            <button onclick="signInAnonymouslyUser()" class="anonymous-sign-in">
                Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ø¨ÛÙ†Ø§Ùˆ (Ú†Ø§ØªÛŒ Ú©Ø§ØªÛŒ)
                <i class="material-icons" style="margin-right: -10px;">person_outline</i>
            </button>
            <p class="mt-4 text-sm text-subtle-gray">
                Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ø¨ÛÙ†Ø§Ùˆ Ù…ÛÚ˜ÙˆÙˆÛŒ Ú†Ø§Øª Ù†Ø§Ù¾Ø§Ø±ÛØ²ÛØª. Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ø¯ÙˆØ§ØªØ± Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛ•Ú©Û•Øª Ø¨Û•Ø±Ø² Ø¨Ú©Û•ÛŒØªÛ•ÙˆÛ•.
            </p>
        </div>
    </div>

    <div id="chat-container" class="chat-container" style="display: none;">
        
        <div class="header">
            <div class="header-title">Ø¦ÛŒØ¦Ø§ÛŒÛŒ Ú©ÙˆØ±Ø¯ÛŒ (Ø¬ÛÙ…ÛŒÙ†ÛŒ)</div>
            <div class="header-actions">
                <button id="load-history-button" class="header-button" style="display: none;">
                    <i class="material-icons">history</i>
                    Ù…ÛÚ˜ÙˆÙˆ
                </button>
                <button id="upgrade-button" class="header-button" onclick="upgradeToGoogle()" style="display: none;">
                    <i class="material-icons">upgrade</i>
                    Ø¨Û•Ø±Ø²Ú©Ø±Ø¯Ù†Û•ÙˆÛ• Ø¨Û† Ú¯ÙˆÙˆÚ¯Úµ
                </button>
                <button id="logout-button" class="header-button" onclick="logout()" style="display: none;">
                    <i class="material-icons">logout</i>
                    Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ•
                </button>
            </div>
        </div>

        <div id="message-area" class="message-area">
            </div>

        <div class="input-area">
            <textarea id="user-input" placeholder="Ù†Ø§Ù…Û•Ú©Û•Øª Ø¨Ù†ÙˆÙˆØ³Û• Ù„ÛØ±Û•..." rows="1"></textarea>
            <button id="send-button" disabled>
                <i class="material-icons">send</i>
            </button>
        </div>

        <div class="footer text-center p-2 text-xs text-gray-500">
            <span id="user-id-display">Ù†Ø§Ø³Ù†Ø§Ù…Û•ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: Ø¨ÛÙ†Ø§Ùˆ</span> |
            <a href="#" target="_blank" class="text-primary-ios-blue hover:underline">Ù…Ø§ÙÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Ø§Ù†</a>
        </div>
    </div>

</body>
</html>
