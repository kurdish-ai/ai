<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ئیئایی کوردی</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>☀️</text></svg>">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        
        // ------------------ IMAGE ASSETS (Standard Google "G" Logo SVG) ------------------
        const defaultGoogleLogoSvg = `
            <svg class="google-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path fill="#4285F4" d="M22.5 12.5c0-.62-.05-1.22-.16-1.8H12v3.38h6.15c-.25 1.4-.99 2.58-2.14 3.46v2.77h3.58c2.09-1.93 3.3-4.75 3.3-8.01z"/>
                <path fill="#34A853" d="M12 23c3.21 0 5.91-1.07 7.88-2.92l-3.58-2.77c-.99.66-2.29 1.05-4.3 1.05-3.32 0-6.13-2.2-7.14-5.18H1.32v2.85C3.38 20.48 7.42 23 12 23z"/>
                <path fill="#FBBC05" d="M4.86 14.15c-.47-1.42-.47-2.92 0-4.34V6.96H1.32c-1.3 2.58-1.3 5.56 0 8.14l3.54-2.95z"/>
                <path fill="#EA4335" d="M12 4.67c1.77 0 3.37.6 4.62 1.77l3.15-3.15C17.91 1.44 15.21 0 12 0 7.42 0 3.38 2.52 1.32 6.96l3.54 2.85c1.01-2.98 3.82-5.14 7.14-5.14z"/>
            </svg>
        `;
        const emptyLogoHtml = defaultGoogleLogoSvg; 

        // ------------------ FIREBASE CONFIGURATION (Provided by User) ------------------
        const userFirebaseConfig = {
            apiKey: "AIzaSyDoTAMAuFm8h9RFWk_C4BnqtwEis-RGor4",
            authDomain: "ai-kurdy.firebaseapp.com",
            projectId: "ai-kurdy",
            storageBucket: "ai-kurdy.firebasestorage.app",
            messagingSenderId: "1071066507145",
            appId: "1:1071066507145:web:46e894ecfab03cecf52358",
            measurementId: "G-044ZEW6C0G"
        };
        
        // ------------------ FIREBASE IMPORTS (UPDATED to include signInWithCredential) ------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, linkWithPopup, signInWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ------------------ GLOBAL VARIABLES FROM ENVIRONMENT ------------------
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = userFirebaseConfig; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db;
        let userId = null;
        const WELCOME_MESSAGE_TEXT = 'بەخێربێیت! من ئیئایی کوردی جێمینیم. چۆن دەتوانم یارمەتیت بدەم؟';

        
        // ------------------ GEMINI SETUP ------------------
        // WARNING: API key is exposed in client-side code. This should be moved to a backend service (e.g., Firebase Function).
        import { GoogleGenAI } from "https://esm.run/@google/genai";
        const apiKey = "AIzaSyDNc6-bEE5GpFt5uq_nTkQKAZPXjuKiXSw"; 
        let chat = null;

        // ------------------ UI ELEMENTS ------------------
        const chatContainer = document.getElementById('chat-container');
        const authContainer = document.getElementById('auth-container');
        const messageArea = document.getElementById('message-area');
        const inputField = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadHistoryButton = document.getElementById('load-history-button');
        const logoutButton = document.getElementById('logout-button');
        const upgradeButton = document.getElementById('upgrade-button');


        // ------------------ CORE UTILITY FUNCTIONS ------------------
        
        /**
         * @returns {boolean} True if the text contains characters specific to Sorani Kurdish.
         */
        function isKurdishSorani(text) {
            const soraniMarkers = /[\u067E\u0686\u0698\u06AF\u06A4]/; 
            return soraniMarkers.test(text);
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const bytesPerSample = 2; 
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataLength = pcm16.length * bytesPerSample;

            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true); 
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);  
            view.setUint16(20, 1, true);    
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);  

            // Data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true); 
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }


        // Custom function to replace alert()
        window.alertMessage = (title, message) => { // Made global to be accessible in HTML button
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'custom-alert';
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <div class="alert-title">${title}</div>
                    <p>${message}</p>
                    <button onclick="document.getElementById('custom-alert').remove()">باشە</button>
                </div>
            `;
            document.body.appendChild(alertDiv);
        };

        // ------------------ LLM TTS FEATURE ------------------

        window.playTTS = async (text, ttsButton) => {
            const originalIcon = ttsButton.innerHTML;
            // Show loading state
            ttsButton.innerHTML = '<i class="material-icons rotating-icon">sync</i> loading...';
            ttsButton.disabled = true;

            const voiceName = "Kore"; 

            const payload = {
                contents: [{
                    parts: [{ text: `Say this text, using the appropriate language and tone: ${text}` }] 
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                let response = null;
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                    } catch (e) {
                        console.warn(`TTS fetch failed (attempt ${i + 1}). Retrying in ${delay / 1000}s...`, e);
                    }
                    if (i < 2) await new Promise(resolve => setTimeout(resolve, delay *= 2));
                }
                
                if (!response || !response.ok) throw new Error("TTS API call failed after retries.");

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                    
                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl); 
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                    };

                    audio.onerror = (e) => {
                        console.error("Audio playback error:", e);
                        alertMessage('هەڵەی لێدانی دەنگ', 'ناتوانرێت دەنگەکە لێبدرێت. ڕەنگە فۆرماتەکە کێشەی هەبێت.');
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                    };
                    
                } else {
                    console.error("Invalid TTS response structure or missing audio data.", result);
                    alertMessage('هەڵەی دەنگ', 'هیچ دەنگێک نەدۆزرایەوە یان فۆرماتەکە هەڵەیە.');
                }
            } catch (error) {
                console.error("TTS generation error:", error);
                alertMessage('هەڵەی گشتی', 'کێشەیەک لە دروستکردنی دەنگەکە ڕوویدا. هۆکار: ' + error.message);
            } finally {
                if (ttsButton.disabled && ttsButton.innerHTML.includes('sync')) {
                    ttsButton.innerHTML = originalIcon;
                    ttsButton.disabled = false;
                }
            }
        };


        // Custom function to replace alert()
        window.alertMessage = (title, message) => { // Made global to be accessible in HTML button
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'custom-alert';
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <div class="alert-title">${title}</div>
                    <p>${message}</p>
                    <button onclick="document.getElementById('custom-alert').remove()">باشە</button>
                </div>
            `;
            document.body.appendChild(alertDiv);
        };

        // ------------------ LLM TTS FEATURE ------------------

        window.playTTS = async (text, ttsButton) => {
            const originalIcon = ttsButton.innerHTML;
            // Show loading state
            ttsButton.innerHTML = '<i class="material-icons rotating-icon">sync</i> loading...';
            ttsButton.disabled = true;

            const voiceName = "Kore"; 

            const payload = {
                contents: [{
                    parts: [{ text: `Say this text, using the appropriate language and tone: ${text}` }] 
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                let response = null;
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                    } catch (e) {
                        console.warn(`TTS fetch failed (attempt ${i + 1}). Retrying in ${delay / 1000}s...`, e);
                    }
                    if (i < 2) await new Promise(resolve => setTimeout(resolve, delay *= 2));
                }
                
                if (!response || !response.ok) throw new Error("TTS API call failed after retries.");

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                    
                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl); 
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                    };

                    audio.onerror = (e) => {
                        console.error("Audio playback error:", e);
                        alertMessage('هەڵەی لێدانی دەنگ', 'ناتوانرێت دەنگەکە لێبدرێت. ڕەنگە فۆرماتەکە کێشەی هەبێت.');
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                    };
                    
                } else {
                    console.error("Invalid TTS response structure or missing audio data.", result);
                    alertMessage('هەڵەی دەنگ', 'هیچ دەنگێک نەدۆزرایەوە یان فۆرماتەکە هەڵەیە.');
                }
            } catch (error) {
                console.error("TTS generation error:", error);
                alertMessage('هەڵەی گشتی', 'کێشەیەک لە دروستکردنی دەنگەکە ڕوویدا. هۆکار: ' + error.message);
            } finally {
                if (ttsButton.disabled && ttsButton.innerHTML.includes('sync')) {
                    ttsButton.innerHTML = originalIcon;
                    ttsButton.disabled = false;
                }
            }
        };


        // ------------------ FIREBASE INITIALIZATION ------------------
        function initializeFirebase() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing or incomplete. Authentication will not work.");
                document.getElementById('auth-error').textContent = "هەڵە: ڕێکخستنەکانی فایەربەیس نادروستن.";
                return;
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            setupAuthListener();
            handleInitialAuth();
        }

        async function handleInitialAuth() {
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom token sign-in failed (system environment issue). User must now choose sign-in method.", error);
                }
            }
        }

        // ------------------ AUTHENTICATION METHODS ------------------
        
        window.logout = async () => {
            try {
                await signOut(auth);
                alertMessage('چوونەدەرەوە سەرکەوتوو بوو', 'بە سەرکەوتوویی لە هەژمارەکەت چوویتە دەرەوە.');
            } catch (error) {
                console.error("Logout failed:", error);
                alertMessage('هەڵەی چوونەدەرەوە', `نەتوانرا لە هەژمارەکە بچیتە دەرەوە: ${error.message}`);
            }
        };

        window.signInWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                alertMessage('هەڵەی چوونەژوورەوە', `هەڵەی چوونەژوورەوەی گووگڵ: ${error.message}`);
            }
        };

        window.signInAnonymouslyUser = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous Sign-In failed:", error);
                alertMessage('هەڵەی چوونەژوورەوە', `هەڵەی چوونەژوورەوەی بێناو: ${error.message}`);
            }
        };

        /**
         * UPDATED: Handles linking an anonymous account, or merging if the Google credential is already in use.
         */
        window.upgradeToGoogle = async () => {
            if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                alertMessage('هەڵە', 'تەنها بەکارهێنەرانی بێناو دەتوانن ئەکاونتیان بەرز بکەنەوە.');
                return;
            }
            
            const provider = new GoogleAuthProvider();

            try {
                // 1. Attempt to link the anonymous user to a new Google account
                await linkWithPopup(auth.currentUser, provider);
                alertMessage('بەرزکردنەوە سەرکەوتوو بوو', 'هەژماری بێناوی ئێستات بە سەرکەوتوویی بەستراوەتەوە بە گووگڵ.');
                
            } catch (error) {
                
                // 2. Handle the specific "credential already in use" error
                if (error.code === 'auth/credential-already-in-use') {
                    
                    // Extract the Google credential the user just signed in with from the error object
                    const googleCredential = GoogleAuthProvider.credentialFromError(error);
                    
                    if (!googleCredential) {
                        alertMessage('هەڵەی بەستنەوە', 'گووگڵ نەیتوانی زانیاری هەژمارەکە بدۆزێتەوە.');
                        return;
                    }
                    
                    // 3. CRUCIAL STEP: Sign in with the credential to automatically merge the anonymous session 
                    // with the existing persistent Google account.
                    try {
                        await signInWithCredential(auth, googleCredential);

                        alertMessage(
                            'بەرزکردنەوەی سەرکەوتوو (یەکخرا)', 
                            'بە سەرکەوتوویی لەگەڵ هەژماری گووگڵی کۆنەکەتدا یەکخرایەوە.'
                        );
                    } catch (mergeError) {
                         console.error("Error during account merge:", mergeError);
                         alertMessage('هەڵەی یەکخستنەوە', `نەتوانرا هەژمارەکان یەکبخرێنەوە: ${mergeError.message}`);
                    }

                } else {
                    // 4. Handle all other errors (e.g., user closing the popup, network issues)
                    console.error("Account upgrade failed:", error);
                    alertMessage('هەڵەی گشتی بەستنەوە', `نەتوانرا ئەکاونتی گووگڵ ببەسترێتەوە: ${error.message}`);
                }
            }
        };
        
        // ------------------ AUTH STATE LISTENER & UI MANAGEMENT ------------------
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `ناسنامەی بەکارهێنەر: ${userId}`; 
                    showAuthScreen(false);
                    
                    const isAnonymous = user.isAnonymous;

                    // --- FIX: Correctly manage Header Buttons based on user type ---
                    if (isAnonymous) {
                        // Anonymous User: Show Upgrade (now blue), Hide Logout, Hide History
                        logoutButton.style.display = 'none';
                        upgradeButton.style.display = 'flex';
                        toggleHistoryButton(false); 
                    } else {
                        // Persistent User (Google, Custom Token): Show Logout, Hide Upgrade, Show History
                        logoutButton.style.display = 'flex';
                        upgradeButton.style.display = 'none';
                        toggleHistoryButton(true); 
                    }

                    // All authenticated users can initialize the chat client
                    initializeChat(user);
                } else {
                    userId = null;
                    userIdDisplay.textContent = 'ناسنامەی بەکارهێنەر: بێناو';
                    showAuthScreen(true);
                    // Ensure buttons are hidden when logged out
                    if(logoutButton) logoutButton.style.display = 'none';
                    if(upgradeButton) upgradeButton.style.display = 'none';
                    toggleHistoryButton(false);
                    // Call initializeChat to reset chat state and show welcome message only
                    initializeChat(null); 
                }
            });
        }

        function showAuthScreen(show) {
            // NOTE: We rely on CSS to hide/show, but use JS to control which one is visible for the animation
            authContainer.style.display = show ? 'flex' : 'none';
            chatContainer.style.display = show ? 'none' : 'flex';
        }
        
        function toggleHistoryButton(show) {
            if (loadHistoryButton) {
                loadHistoryButton.style.display = show ? 'flex' : 'none'; 
            }
        }


        // ------------------ FIRESTORE HISTORY LOGIC ------------------

        function getChatCollectionRef() {
            const collectionName = 'chat_history';
            // History is stored publicly for persistence across Google sessions
            const publicPath = `/artifacts/${appId}/public/data/${collectionName}`; 
            return collection(db, publicPath);
        }

        function loadChatHistory() {
            // Only attempt to load history for persistent users
            if (!userId || !db || auth.currentUser.isAnonymous) return;

            // Only load history where the userId matches the current user
            const q = query(
                getChatCollectionRef(),
                where('userId', '==', userId)
            );

            onSnapshot(q, (snapshot) => {
                messageArea.innerHTML = ''; 
                // Welcome message does NOT need a TTS button
                appendMessage('ai', WELCOME_MESSAGE_TEXT, false, false); 

                let chatMessages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.timestamp && data.text && data.text !== WELCOME_MESSAGE_TEXT) {
                         chatMessages.push({ ...data, id: doc.id });
                    }
                });
                
                chatMessages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                chatMessages.forEach(msg => {
                    // History messages need the language check for the TTS button
                    appendMessage(msg.role, msg.text, false, true); 
                });
                messageArea.scrollTop = messageArea.scrollHeight;
            }, (error) => {
                console.error("Error loading chat history:", error);
            });
        }

        window.loadChatHistory = loadChatHistory; // Make history function global


        // ------------------ GEMINI CHAT LOGIC ------------------

        function initializeChat(user) {
            messageArea.innerHTML = '';
            // Welcome message should always be visible
            appendMessage('ai', WELCOME_MESSAGE_TEXT, false, false);
            
            if (user) {
                 // FIX: All authenticated users (anonymous or persistent) get a chat client
                 chat = new GoogleGenAI({ apiKey }).chats.create({ 
                    model: "gemini-2.5-flash", 
                    systemInstruction: "You are a helpful, conversational AI assistant. You should primarily respond in the language the user is speaking, or the language requested by the user. Maintain a polite and helpful tone.",
                    config: {
                        tools: [{ google_search: {} }]
                    }
                });

                inputField.disabled = false;
                sendButton.disabled = false;
                inputField.focus();

                // Only set up history retrieval for PERSISTENT users
                if (db && !user.isAnonymous) { 
                    loadHistoryButton.onclick = loadChatHistory; 
                    loadChatHistory();
                } else {
                    loadHistoryButton.onclick = () => alertMessage('تێبینی', 'بۆ بەکارهێنەرانی بێناو، چاتەکە بەردەوام نابێت. تکایە ئەکاونتەکەت بەرز بکەرەوە بۆ گۆگڵ بۆ پاراستنی مێژووەکە.');
                }

            } else {
                // For Logged out users
                chat = null;
                inputField.disabled = true;
                sendButton.disabled = true;
            }

            // Always assign click handlers but they'll be disabled if chat is null/input is disabled
            sendButton.onclick = sendMessage;
            inputField.onkeypress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    sendMessage();
                }
            };
        }

        /**
         * Function to create and append a new message to the chat.
         */
        function appendMessage(sender, text, scroll = true, showTtsButton = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            
            const iconHTML = sender === 'ai' ? '<div class="icon">🤖</div>' : '<div class="icon">ت</div>';
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('text-content');
            contentDiv.innerHTML = text; 

            if (sender === 'ai') {
                
                // CONDITIONAL TTS LOGIC
                const isKurdish = isKurdishSorani(text);
                // Only show TTS button if it's NOT Kurdish (to use the limited English/other voice)
                const shouldShowFinalTTS = showTtsButton && !isKurdish; 
                
                const bubbleContent = document.createElement('div');
                bubbleContent.classList.add('ai-bubble-content');
                
                bubbleContent.appendChild(contentDiv);

                if (shouldShowFinalTTS) {
                    const ttsButton = document.createElement('button');
                    ttsButton.classList.add('tts-button');
                    ttsButton.innerHTML = '<i class="material-icons">volume_up</i> ✨گوێگرتن';
                    ttsButton.title = 'گوێگرتن بە دەنگی جێمینی';

                    ttsButton.onclick = () => window.playTTS(text, ttsButton);
                    
                    bubbleContent.appendChild(ttsButton);
                }

                messageDiv.innerHTML = iconHTML;
                messageDiv.appendChild(bubbleContent);
                messageDiv.style.alignSelf = 'flex-start'; 
                
            } else {
                 messageDiv.innerHTML = contentDiv.outerHTML + iconHTML;
                 messageDiv.style.flexDirection = 'row-reverse';
                 messageDiv.style.alignSelf = 'flex-end';
            }
            
            messageArea.appendChild(messageDiv);
            if (scroll) {
                messageArea.scrollTop = messageArea.scrollHeight;
            }
            return contentDiv;
        }

        async function sendMessage() {
            const prompt = inputField.value.trim();
            
            // FIX: Check if prompt is empty OR chat client is not initialized (e.g., logged out user)
            if (prompt === "" || !chat) {
                return;
            }
            
            // This flag determines if we should try to save to Firestore
            const isPersistentUser = auth.currentUser && !auth.currentUser.isAnonymous;

            // 1. Add user message to the UI
            appendMessage('user', prompt);
            inputField.value = '';
            inputField.disabled = true;
            sendButton.disabled = true;

            // 1.5. SAVE USER MESSAGE TO FIRESTORE (Only for persistent users)
            if (userId && db && isPersistentUser) { 
                try {
                    await addDoc(getChatCollectionRef(), {
                        userId: userId,
                        role: 'user',
                        text: prompt,
                        timestamp: serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding user message to history:", e);
                }
            }


            // 2. Add a loading indicator for the AI's response
            const aiMessageContent = appendMessage('ai', '...');
            let aiResponseText = '';
            
            try {
                // 3. Call the Gemini API 
                const response = await chat.sendMessage({ message: prompt });
                aiResponseText = response.text;
                
                // --- Re-check language and re-render the message bubble if the TTS button is needed/not needed ---
                const isKurdish = isKurdishSorani(aiResponseText);
                const shouldShowFinalTTS = !isKurdish;

                // Create a new temporary element to rebuild the AI message content correctly
                const tempDiv = document.createElement('div');
                tempDiv.classList.add('ai-bubble-content');

                const newTextContent = document.createElement('div');
                newTextContent.classList.add('text-content');
                newTextContent.innerHTML = aiResponseText;
                tempDiv.appendChild(newTextContent);

                if (shouldShowFinalTTS) {
                    const ttsButton = document.createElement('button');
                    ttsButton.classList.add('tts-button');
                    ttsButton.innerHTML = '<i class="material-icons">volume_up</i> ✨گوێگرتن';
                    ttsButton.title = 'گوێگرتن بە دەنگی جێمینی';
                    ttsButton.onclick = () => window.playTTS(aiResponseText, ttsButton);
                    tempDiv.appendChild(ttsButton);
                }

                // Find the parent message container and replace its content
                const parentMessage = aiMessageContent.closest('.message');
                const existingBubble = aiMessageContent.closest('.ai-bubble-content');
                
                if (parentMessage && existingBubble) {
                    // Replace the existing bubble content with the finalized one
                    existingBubble.replaceWith(tempDiv);
                } else {
                    aiMessageContent.innerHTML = aiResponseText;
                }
                // ------------------------------------------------------------------------------------------------


                // 4.5. SAVE AI MESSAGE TO FIRESTORE (Only for persistent users)
                if (userId && db && isPersistentUser) { 
                     try {
                        await addDoc(getChatCollectionRef(), {
                            userId: userId,
                            role: 'ai',
                            text: aiResponseText,
                            timestamp: serverTimestamp()
                        });
                    } catch (e) {
                        console.error("Error adding AI message to history:", e);
                    }
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                aiMessageContent.innerHTML = '<strong>هه‌ڵه‌:</strong> ببوره‌، په‌یوه‌ندی له‌گه‌ڵ جێمینی پچڕا. سه‌یری کۆنسۆڵەکە بکه‌ بۆ زانیاری زیاتر.';
            } finally {
                // 5. Re-enable input
                inputField.disabled = false;
                sendButton.disabled = false;
                inputField.focus();
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        }

        // Start the application after the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const placeholder = document.getElementById('google-icon-placeholder');
            if (placeholder) {
                placeholder.innerHTML = emptyLogoHtml;
            }
            initializeFirebase();
        });

    </script>
    <style>
        /* General Setup - Apple-like Aesthetics */
        :root {
            /* UPDATED COLOR PALETTE FOR BLACK/GREY THEME */
            --primary-ios-black: #000000; /* New primary color */
            --primary-ios-dark-grey: #4A4A4A; /* New primary text/icon color */
            --background-light: #F2F2F7;
            --card-background: #FFFFFF;
            --text-dark: #1D1D1F;
            --border-color: #D1D1D6;
            --bubble-ai: #E5E5EA; 
            --subtle-gray: #6D6D72;
            --warning-red: #FF3B30;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: var(--background-light); 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            color: var(--text-dark);
            font-weight: 500; 
        }
        
        /* ------------------ NEW ANIMATION STYLES ------------------ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-on-load {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* -------------------------------------------------------- */


        /* Custom Alert Modal */
        .custom-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .alert-content {
            background: var(--card-background);
            padding: 20px 30px;
            border-radius: 12px;
            text-align: right;
            max-width: 90%;
            direction: rtl;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .alert-title {
            font-weight: 700;
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--warning-red);
        }

        .alert-content p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .alert-content button {
            /* Changed from blue to dark grey */
            background-color: var(--primary-ios-dark-grey); 
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            float: left; 
            transition: opacity 0.2s;
        }
        .alert-content button:hover {
            opacity: 0.9;
        }

        /* Container Styles - WIDER DESKTOP VIEW */
        .chat-container, .auth-container {
            width: 95%; 
            max-width: 1200px; 
            height: 100%;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        /* Mobile-specific styles (<= 800px) */
        @media (max-width: 800px) {
            .chat-container, .auth-container {
                max-width: 100%; 
                width: 100%;
                border-radius: 0;
                margin: 0;
                box-shadow: none;
            }
        }

        /* AUTH SCREEN STYLES */
        .auth-container {
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
            opacity: 0; /* Starts hidden for animation */
        }
        .auth-card {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }
        .auth-card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
        }
        .auth-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 15px;
            /* Default button style */
            border: 2px solid var(--primary-ios-dark-grey); /* Grey border */
            background-color: white;
            color: var(--text-dark);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            direction: rtl;
        }
        .auth-button:hover {
            background-color: var(--background-light);
        }
        .auth-button .google-icon {
            width: 24px;
            height: 24px;
            margin-left: 10px;
            margin-right: 0;
        }
        .auth-button.anon {
            /* Anonymous Button is dark gray */
            background-color: var(--primary-ios-dark-grey);
            color: white;
            border-color: var(--primary-ios-dark-grey);
        }

        /* Chat Layout */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .header-title {
            font-size: 20px;
            font-weight: 600;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            /* Default text color is dark grey */
            color: var(--primary-ios-dark-grey);
            background-color: transparent;
        }
        .header-button:hover {
            background-color: #F0F0F0;
        }
        
        /* NEW BLUE UPGRADE BUTTON STYLE */
        .header-button.upgrade-google {
            /* Force blue text and border */
            color: #1565C0 !important;
            border: 1px solid #1565C0 !important; 
            background-color: transparent !important;
        }
        .header-button.upgrade-google:hover {
            background-color: rgba(21, 101, 192, 0.1) !important;
        }
        
        .header-button i {
            font-size: 20px;
            margin-left: 5px;
        }

        /* Message Area */
        #message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Message Bubbles */
        .message {
            max-width: 80%;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .message .icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            /* Icon color kept as dark grey for the chat interface */
            background-color: var(--primary-ios-dark-grey);
            color: white;
            flex-shrink: 0;
            margin-top: 5px;
        }
        .message.user .icon {
            background-color: var(--subtle-gray);
            color: white;
        }

        .text-content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
            text-align: right;
            word-wrap: break-word;
        }

        .message.user .text-content {
            /* User message bubble is black */
            background-color: var(--primary-ios-black);
            color: white;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-left-radius: 18px;
            border-bottom-right-radius: 4px; 
        }

        .message.ai .ai-bubble-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .message.ai .text-content {
            background-color: var(--bubble-ai);
            color: var(--text-dark);
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            border-bottom-left-radius: 4px; 
        }
        
        .tts-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            /* TTS button text/icon color is dark grey */
            color: var(--primary-ios-dark-grey); 
            font-size: 14px;
            font-weight: 600;
            margin-top: 5px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .tts-button:hover {
            background-color: rgba(74, 74, 74, 0.1); 
        }
        .tts-button i {
            font-size: 18px;
            margin-left: 5px;
        }

        /* Input Area */
        .input-area {
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #fff;
        }
        #user-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 16px;
            resize: none;
            height: 40px; 
            max-height: 100px;
            overflow-y: auto;
            direction: rtl; 
        }
        #send-button {
            /* Send button is black */
            background-color: var(--primary-ios-black);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        #send-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* Rotating Icon for loading */
        .rotating-icon {
            animation: rotate 1s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="chat-container" class="chat-container animate-on-load">
        <div class="header">
            <div class="header-actions">
                <button id="logout-button" onclick="logout()" class="header-button" style="display: none;">
                    <i class="material-icons">logout</i> چوونەدەرەوە
                </button>
                <button id="upgrade-button" onclick="upgradeToGoogle()" class="header-button upgrade-google" style="display: none;">
                    <i class="material-icons">person_add</i> بەرزکردنەوە بۆ گووگڵ
                </button>
                <button id="load-history-button" onclick="loadChatHistory()" class="header-button" style="display: none;">
                    <i class="material-icons">history</i> مێژوو
                </button>
            </div>
            <div class="header-title">ئیئایی کوردی (جێمینی)</div>
        </div>

        <div id="message-area">
            </div>

        <div class="input-area">
            <button id="send-button" disabled>
                <i class="material-icons">send</i>
            </button>
            <textarea id="user-input" placeholder="پەیامەکەت بنووسە..." rows="1" disabled></textarea>
        </div>
        <div id="user-id-display" class="p-2 text-xs text-center text-gray-500">ناسنامەی بەکارهێنەر: بێناو</div>
    </div>

    <div id="auth-container" class="auth-container animate-on-load" style="display: flex;">
        <div class="auth-card">
            <h2>بەخێربێیت بۆ ئیئایی کوردی</h2>
            <div id="auth-error" class="text-red-500 mb-4 font-bold"></div>
            <button onclick="signInWithGoogle()" class="auth-button">
                <div id="google-icon-placeholder"></div>
                چوونەژوورەوە بە گووگڵ
            </button>
            <button onclick="signInAnonymouslyUser()" class="auth-button anon">
                <i class="material-icons" style="margin-left: 10px;">visibility_off</i>
                بە بێناوی بەردەوام بە (مێژوو پارێزراو نییە)
            </button>
        </div>
    </div>

    <div id="alertContainer"></div>

</body>
</html>
